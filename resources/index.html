<!DOCTYPE html>
<!-- Copyright 2018 (c). All rights reserved. But we don't really care, so do what you must. -->

<html>

<head>
	<title>Project-ER</title>
	
	<!-- Favicon! -->
	<link href="resources/favicon.ico" rel="icon"/>

	<!-- Get the Ubuntu Monospace font from Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet"/>

	<!-- Mobile website support -->
	<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, user-scalable=no"/>

	<!-- Page CSS -->
	<link href="resources/index.css" rel="stylesheet"/>

	<!-- Fixes the awkward sizes of the JSON sample blocks. -->
	<script>
		// Get the document element
		const docElem = document.documentElement;

		const IDEAL_WIDTH = 650;
		const WINDOW_WIDTH_RATIO = 0.55;

		let apiSamples = [];
		let apiSampleIdx = 0;
		let firstResize = true;

		window.onload = () => {
			// Save the initial window width value
			let prevWindowWidth = docElem.clientWidth;

			// Get the bodydiv element
			const bodyDiv = document.getElementById("bodydiv");

			// Attach the example JSON to the /WeeklyMenu list entry
			loadJsonExampleText("resources/weeklymenu.html", document.getElementById("weeklymenuapi"));

			// Attach the example JSON to the /Today list entry
			loadJsonExampleText("resources/todaymenu.html", document.getElementById("todaymenuapi"));

			// Attach the example JSON to the /Baker, /North, /Seibel, /SidRich/ South, and /West list entry
			loadJsonExampleText("resources/locationmenu.html", document.getElementById("locationmenuapi"));
		
			// Add the date since the last time the server updated
			let lastUpdateRequest = createAjaxCall("/LastUpdate", lastUpdateText => {
				// Create the new element to be appended to the target element
				let newElement = document.createElement("p");

				// Set the ID tag so that the CSS may style it.
				newElement.id = "lastupdateapi";

				// Create the node that holds the text
				let newElementText = document.createTextNode(lastUpdateText);

				newElement.appendChild(newElementText);

				// The target element in this case is the bodyDiv element
				let targetElement = document.getElementById("bodydiv");

				// Append it to the end of the target element.
				targetElement.appendChild(newElement);
			}, status => console.error("Request for '/LastUpdate' failed with status " + status));
			lastUpdateRequest.send();

			// Wait until all async JSON example requests have completed to commence resizing handlers
			finish(() => {
				let examples = document.getElementsByClassName("jsontextbox");

				// Handle the elements that require dynamic resizing.
				window.onresize = () => {
					// If the new window height change is significant, update the window height value used for calculating the body width
					let resizeBodyDiv = firstResize || prevWindowWidth != docElem.clientWidth;

					// Make sure that the main text of the body looks good
					if (resizeBodyDiv) {
						bodyDiv.style.width = ((WINDOW_WIDTH_RATIO + (docElem.clientWidth > window.innerHeight ? 0 : (1 - docElem.clientWidth / window.innerHeight) * (1 - WINDOW_WIDTH_RATIO))) * docElem.clientWidth) + "px";

						firstResize = false;
						prevWindowWidth = docElem.clientWidth;
					}

					// Resize the API example text boxes
					for (let i = 0; i < examples.length; i++) {
						let apiSample = examples[i];
						let apiSampleRect = apiSample.getBoundingClientRect();

						apiSample.style.width = docElem.clientWidth - 2 * apiSampleRect.x + "px";
					}
				};

				// Fire a resize event so that the elements are sized correctly upon initiation
				window.dispatchEvent(new Event("resize"));
			});
		};

		function loadJsonExampleText(htmlPath, tE) {
			// Get the location that this example is registered on in the apiSamples array.
			const targetIdx = apiSampleIdx++;
			const targetElement = tE;

			// Register the new entry in the apiSamples array.
			apiSamples[targetIdx] = null;

			let xhttp = createAjaxCall(htmlPath, responseText => {
				// Create the new element to be appended to the target element
				let newElement = document.createElement("p");

				// Set the element's attributes
				newElement.innerHTML = responseText;

				// Append it to the end of the target element.
				while (newElement.firstChild)
					targetElement.appendChild(newElement.firstChild);

				apiSamples[targetIdx] = targetElement.lastChild;
			}, status => console.error("Request for '" + htmlPath + "' failed with status " + status));

			// Delaying sending the request allows the finish function a chance to detect that a new entry has been added.
			setTimeout(() => xhttp.send(), 5);
		}

		function createAjaxCall(requestPath, successCallback, failCallback) {
			let xhttp = new XMLHttpRequest();

			xhttp.onreadystatechange = function () {
				if (this.readyState == 4 && this.status == 200)
					successCallback(this.responseText);

				else if (this.readyState == 4)
					failCallback(this.status);
			};

			xhttp.open("GET", requestPath, true);

			return xhttp;
		}

		function finish(callback) {
			let ready = apiSamples.length;
			for (let i = 0; i < apiSamples.length; i++) {
				if (apiSamples[i] == null || apiSamples[i] == undefined) {
					ready = false;
					break;
				}
			}

			if (ready) 
				callback();
			else
				setTimeout(finish, 1, callback);
		}
	</script>
</head>

<body>
	<h1>Welcome to Project-ER!</h1>
	<div id="bodydiv">
		<h2 id="about">About Project-ER</h2>
		<hr>
		<p>Project-ER, namely Project Eat Rice, is written in JavaScript using <a class="referencelink boldtext" href="https://nodejs.org/en/" target="_blank">Node.js</a> + <a class="referencelink boldtext" href="https://expressjs.com/" target="_blank">Express</a> + <a class="referencelink boldtext" href="https://www.npmjs.com/package/download" target="_blank">download-file</a> + <a class="referencelink boldtext" href="https://www.npmjs.com/package/pdf2json" target="_blank">pdf2json</a>. </p>

		<p>It began as a proof-of-concept during HackRice 7.5 in 2018. Even though the idea of providing a way to get menu information at Rice is not original, the devs noted that nobody had provided an easy way to access the weekly menu information from the Rice Dining website. This project aim to tackle this. It takes the weekly servery menus found <a class="referencelink boldtext" href="http://dining.rice.edu/undergraduate-dining/college-serveries/weekly-menus/" target="_blank">here</a>, and then converts them from PDF format into an easy-to-process JSON format. Though this solution is far from perfect, it shows that the menu information can be obtained and organized from the PDF file format.</p>

		<p>To get started, simply create your own application that can make GET requests over the internet to <span class="referencelink boldtext" id="thisurl"></span> (this page). Then simply specify which API you want to use and the appropriate response data will be sent. The APIs are outlined in greater detail below. More APIs are planned to be implemented in the near future, so stay tuned for those.</p>

		<p>Source code for Project-ER can be found <a class="referencelink boldtext" href="https://github.com/tacowhisperer/projectER" target="_blank">here</a>.</p>

		<br>

		<h2 id="apiusage">API Usage</h2>
		<hr>
		<p>The list below shows the different GET requests and outputs of those requests. Note that any text that is in bold in the examples should be interpreted literally.</p>
		<ul>
			<li id="weeklymenuapi">
				<a class="getrequest" href="/WeeklyMenu" target="_blank">&#47;WeeklyMenu</a>: Returns a JSON object (<span class="boldtext">application/json</span>) of the weekly menu for all serveries that have a weekly menu PDF <a href="http://dining.rice.edu/undergraduate-dining/college-serveries/weekly-menus/" target="_blank">here</a>. The format of this JSON object is as follows:

				<br>
			</li>

			<br>

			<li id="todaymenuapi">
				<a class="getrequest" href="/Today" target="_blank">&#47;Today</a>: Returns a JSON object (<span class="boldtext">application/json</span>) of the menu for all serveries for the day that the GET request is sent (Monday, Tuesday, etc.). The format of this JSON object is as follows:

				<br>
			</li>

			<br>

			<li>
				<a class="getrequest" href="/Monday" target="_blank">&#47;Monday</a>, <a class="getrequest" href="/Tuesday" target="_blank">&#47;Tuesday</a>, <a class="getrequest" href="/Wednesday" target="_blank">&#47;Wednesday</a>, <a class="getrequest" href="/Thursday" target="_blank">&#47;Thursday</a>, <a class="getrequest" href="/Friday" target="_blank">&#47;Friday</a>, <a class="getrequest" href="/Saturday" target="_blank">&#47;Saturday</a>, <a class="getrequest" href="/Sunday" target="_blank">&#47;Sunday</a>: Returns a JSON object (<span class="boldtext">application/json</span>) of the menu for all serveries for the specified day. The format of this JSON object is exactly the same as <a class="getrequest" href="/Today" target="_blank">&#47;Today</a>.
			</li>

			<br>
			<br>

			<li id="locationmenuapi">
				<a class="getrequest" href="/Baker" target="_blank">&#47;Baker</a>, <a class="getrequest" href="/North" target="_blank">&#47;North</a>, <a class="getrequest" href="/Seibel" target="_blank">&#47;Seibel</a>, <a class="getrequest" href="/SidRich" target="_blank">&#47;SidRich</a>, <a class="getrequest" href="/South" target="_blank">&#47;South</a>, <a class="getrequest" href="/West" target="_blank">&#47;West</a>: Returns a JSON object (<span class="boldtext">application/json</span>) of the menu schedule for lunch and dinner for the specified location. The format of this JSON object is as follows:

				<br>
			</li>

			<br>

			<li>
				<a class="getrequest" href="/LastUpdate" target="_blank">&#47;LastUpdate</a>: Returns text (<span class="boldtext">text/plain</span>) of the last time the server obtained information from the Rice Dining page. Note that this time is local to the server and not the calling machine. The returned HTML is formatted as follows:

				<br>

				<pre class="jsontextbox" id="lastupdateexample"><b>Last Menu Update: </b>YYYY<b>-</b>M?M<b>-</b>D?D HH<b>:</b>MM<b>:</b>SS <b>GMT</b>[+-]\d+ <b>(</b>Timezone String<b>)</b></pre>
			</li>
		</ul>

		<br>

		<h2 id="thedevteam">The Developer Team</h2>
		<hr>
		<p>Project-ER was spearheaded by Rice University undergraduate students <a class="referencelink" href="https://github.com/DrProfSgtMrJ" target="_blank">Jade Dever Matthews</a> and <a class="referencelink" href="https://github.com/tacowhisperer" target="_blank">Andres Salgado</a>. Both developers are aspiring CS majors, and enjoy a good game of Smash Brothers after class.</p>

		<br>

		<h2 id="troubleshooting">Troubleshooting</h2>
		<hr>
		<p>If you can see this page, it means that the server is up and running as expected. However, if something is not behaving as it should be, send a message to either Andres (<a href="mailto:as100@rice.edu">as100@rice.edu</a>) or Jade (<a href="mailto:jcd7@rice.edu">jcd7@rice.edu</a>) to fix it as soon as possible.</p>

		<br>

		<h2 id="licensing">Licensing and Terms of Usage</h2>
		<hr>
		<p>The exact licencing policy is still to be determined. In the meantime, any and all aspects of Project-ER are free to use as seen fit. All we ask is that credit be given where credit is due.</p>
	</div>
</body>

</html>